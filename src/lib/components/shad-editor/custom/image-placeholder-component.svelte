<script lang="ts">
	import { Button, buttonVariants } from '$lib/components/ui/button/index.js';
	import type { NodeViewProps } from '@tiptap/core';
	import { ImageIcon, X } from 'lucide-svelte';
	import { NodeViewWrapper } from 'svelte-tiptap';
	import * as Popover from '$lib/components/ui/popover/index.js';
	import { Input } from '$lib/components/ui/input/index.js';
	const { node, editor, selected, deleteNode, updateAttributes }: NodeViewProps = $props();
	import { open } from '@tauri-apps/plugin-dialog';
	import { pictureDir } from '@tauri-apps/api/path';
	import { convertFileSrc } from '@tauri-apps/api/core';

	async function handleLocalFile() {
		const image = await open({
			multiple: false,
			defaultPath: await pictureDir(),
			title: 'Choose an image',
			filters: [{ name: 'Images', extensions: ['jpg', 'png', 'gif', 'svg'] }]
		});
		if (image === null) return;
		const src = convertFileSrc(image);
		editor.chain().focus().setImage({ src }).run();
	}
</script>

<NodeViewWrapper class="w-full">
	<Popover.Root>
		<Popover.Trigger
			class={buttonVariants({
				variant: 'outline',
				class: 'h-fit w-full bg-muted/50 p-0'
			})}
		>
			<div contenteditable="true" class="flex w-full items-center justify-start p-4">
				<ImageIcon class="mr-2" />
				<span>Add an Image</span>
			</div>
		</Popover.Trigger>
		<Popover.Content class="bg-popover shadow-lg *:my-2">
			<div class="flex items-center justify-between">
				<h1 class="text-xl font-bold">Image</h1>
				<Popover.Close>
					<X class="size-4 text-muted-foreground" />
				</Popover.Close>
			</div>
			<p>Insert image url</p>
			<Input
				placeholder="Enter image url..."
				type="url"
				onchange={(e) => {
					if (e !== null && e.target !== null) {
						//@ts-ignore
						editor.chain().focus().setImage({ src: e.target.value }).run();
					}
				}}
				class="w-full"
			/>
			<p class="font-bold">OR</p>
			<p>Pick an Image</p>
			<Button variant="ghost" class="h-fit w-full bg-muted/50 p-0" onclick={handleLocalFile}>
				<div class="flex w-full items-center justify-start p-4">
					<span>Choose from your device</span>
				</div>
			</Button>
		</Popover.Content>
	</Popover.Root>
</NodeViewWrapper>
